---
title: "Influential Factors in Critical Care Patients"
author: "Samantha Brown, Laura Cosgrove, Francis Z. Fang zf2211"
date: "12/2/2018"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

Group members: Samantha Brown (UNI: slb2240), Laura Cosgrove (UNI: lec2197), and Francis Z. Fang (UNI: zf2211). 

### Introduction

Critical care involves the specialized treatment of patients whose conditions pose life-threatening risks and require around-the-clock care. Critical care treatment typically takes place in an intensive care unit (ICU) of a hospital. Due to the nature of critical care, many patients eventually recover, but some die. For the purpose of this project, we seek to explore factors that influence critical care patients.

### Motivation and Related Work

Previous research has focused on the physiologic- and disease-driven factors that influence critical care. In this report, we consider whether demographic characteristics of patients in critical care influence outcomes such as mortality and length of hospital stay. 

Related work includes a 2015 NIH research publication titled _"Mortality prediction in the ICU: can we do better? Results from the Super ICU Learner Algorithm (SICULA) project, a population-based study"_, which considers whether a machine learning technique can help predict mortality for patients in critical care.

As some of us worked in health related facilities, we found that there are a lot of patients suffered with pain and life loss. we would like to analysis data collected in hospital to find the inner connection between mortality and other factors, in order to help health related facilities, like CDC and hospital to better control different factors to better help patients.

## Data Collection

MIMIC is an openly accessible critical care database created by the MIT Lab for Computational Physiology. It comprises deidentified health-related data associated with over forty thousand patients who stayed in critical care units of the Beth Israel Deaconess Medical Center between 2001 and 2012. It includes the following information: demographics, vital sign measurements made at the bedside (~1 data point per hour), laboratory test results, procedures, medications, caregiver notes, imaging reports, and mortality (both in and out of hospital). After completing the CITI “Data or Specimens Only Research” training course, PhysioNet granted us access to the MIMIC datasets.

The next step was to follow the 



## Initial Questions

Are there inner relations between mortality and other factors? Since we have a lot of factors found in our data collected, which of them are more critical and pay more attention?

To be specific, since this is a highly diversified society, some factors more political, like ethnicity, language, religion will influence on outcome, rather than only medical factors. Let's do some more exhaustive work and find more inclusive results.

I tried to read the database of openFDA, found it is .json format. So we googled and found the API to read the database, and it worked! 

At first, I focus on the admissions.csv from MIMIC because I think it includes so many factors, which are large enough to find something. So we found the paper which called 'Data Descriptor- MIMIC-III, a freely accessible critical care database.pdf' Then we found using the method from the paper, the diagnosis is too much, too hard to use itself to analyze. So we found the sapsii.csv, which used the more detailed scores system to judge the patient, for better analyse its diagnosis.


## Data

This project used a series of research which whole name is MIMIC-III (Medical Information Mart for Intensive Care III). This dataset is notable for three factors:


* it is freely available to researchers worldwide


* it encompasses a diverse and very large population of ICU patients


* it contains high temporal resolution data including lab results, electronic documentation, and bedside monitor trends and waveforms.




## Exploratory Analysis

```{r, message = FALSE, warning = FALSE, include = FALSE}
admissions <- 
  read_csv("./database/data/admissions.csv") %>% 
  janitor::clean_names() %>% 
  mutate(diagnosis = factor(diagnosis))
```


The core admissions dataset consists of `r nrow(admissions)` observations of the following `r ncol(admissions)` variables:

* Row ID
* Subject ID
* HADM ID (hospital admission ID)
* Admit time
* Discharge time
* Death time 
* Admission type
* Admission location
* Discharge location
* Insurance
* Language
* Religion
* Marital status
* Ethnicity
* ED REG time
* ED OUT time
* Diagnosis
* Hospital expire flag
* Has chart events


```{r, include = FALSE}
## Distribution of admission type
admission_type_df = admissions %>% 
  group_by(admission_type) %>% 
  count() %>% 
  mutate(percent_of_patients = round(n/nrow(admissions)*100, digits = 2)) %>% 
  arrange(desc(percent_of_patients)) %>% 
  select(-n)

##ggplot(admission_type_df, aes(x = reorder(admission_type, percent_of_patients), y = percent_of_patients)) + geom_col()
```


_Initial exploration_

* `r admission_type_df[1,2]`% of patients admitted were classified as emergencies, while `r admission_type_df[2,2]`% were newborns and `r admission_type_df[1,2]`% were elective. The remaining `r 100 - (admission_type_df[1,2] + admission_type_df[2,2] + admission_type_df[3,2])`% were classified as urgent.

```{r, include = FALSE}
## Distribution of insurance type
insurance_df = admissions %>% 
  group_by(insurance) %>% 
  count() %>% 
  mutate(percent_of_patients = round(n/nrow(admissions)*100, digits = 2)) %>% 
  arrange(desc(percent_of_patients)) %>% 
  select(-n)
```

* `r insurance_df[[1, 2]]`% of patients had Medicare, while `r insurance_df[[2, 2]]`% had private insurance and `r insurance_df[[3, 2]]`% had Medicaid. The remaining patients either were insured by the government or paid out of pocket.

```{r, include = FALSE}
## Marital Status
marital_status = admissions %>% 
  group_by(marital_status) %>% 
  count() %>% 
  mutate(percent = n/nrow(admissions)*100) %>% 
  arrange(desc(percent))
```

* `r round(marital_status[1,3], digits = 2)`% of the critical care patients were married, `r round(marital_status[2, 3], digits = 2)`% of patients were single, `r round(marital_status[4,3], digits = 2)`% were widowed and `r round(marital_status[5,3], digits = 2)`% were divorced. The remaining `r round(100 - (marital_status[1,3] + marital_status[2, 3] + marital_status[4,3] + marital_status[5,3]), digits = 2)`% were either separated, with a life partner, or marital status was unknown.

```{r, include = FALSE}
## Ethnicity
admissions %>% 
  distinct(ethnicity) %>% 
  nrow()

ethnicity_df = admissions %>% 
  group_by(ethnicity) %>% 
  count() %>% 
  mutate(percent = n/nrow(admissions)*100) %>% 
  arrange(desc(percent))
```

* I need help with sorting out the ethnicity please!!

```{r, include = FALSE}
## Language

language_df = admissions %>% 
  group_by(language) %>% 
  count() %>% 
  mutate(percent = n/nrow(admissions)*100) %>% 
  arrange(desc(percent))
```


* `r round(language_df[[2, 3]], digits = 2)`%  of the patients were missing data entries for language. Of the patients that did have language entries, `r round(language_df[[1, 3]], digits = 2)`% of them spoke English.  


For the scope of this project, we are especially interested in focusing on patient mortalities and length of hospital stay. The depth of our initial analysis is concentrated here.

```{r, include = FALSE}
n_admits = admissions %>% 
  nrow()

n_discharge = admissions %>% 
  filter(is.na(deathtime)) %>% 
  nrow()
```

Out of the `r admissions %>% nrow()` patient admissions, `r round((admissions %>%  filter(is.na(deathtime)) %>%  nrow())/(admissions %>% nrow())*100, digits = 2)`% patients were ultimately discharged. The remaining `r round((1 - (n_discharge/n_admits)) * 100, digits = 2)`% were recorded as patient deaths.

```{r, message = FALSE}
icu_data = read_csv("./database/data/icu_detail.csv") %>% 
  filter(!(los_hospital < 0), !(los_icu < 0))

ggplot(icu_data, aes(x = los_icu, y = los_hospital)) +
  geom_point() +
  labs(
    x = "Length of Stay in ICU, in days", 
    y = "Total Length of Stay in Hospital, in days" 
  )
```


**Let's explain the process of making simpler diagnostic groups** Then include top 10 diagnoses associated with death.




## Additional Analysis

I dig deep into the dataset, we tried to build different models to find the best one. In research, we found a obstacle to analyse this dataset: the observations is too large (over 50000 by now). Since I am lack of this kind of experience, I tried different methods. The stepwise method does not work, so use backward elimination instead. 



## Discussion

We were very ambitious and there were some limitations to using such an ambitious dataset. For example, ...

## Conclusion

